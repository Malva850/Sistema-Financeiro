unit UPagamentos;

interface

uses FireDAC.Comp.Client;

type
  TPagamentos = class
  private
  XCDPagamentos : Integer;
  XNMPagamentos : String;
    procedure SetCDPagamentos(const Value: Integer);
    procedure SetNMPagamentos(const Value: String);

  public
    constructor create;
    function Inserir(var PCodigo : Integer; var PMensagem:String): Boolean;
    function Alterar(var PMensagem:String): Boolean;
    function Apagar(var PMensagem:String): Boolean;
    function Localizar(PCodigo, PNome : String; var Query : TFDQuery): boolean;


  published
    property CDPagamento : Integer  read XCDPagamentos write SetCDPagamentos;
    property NMPagamento : String  read XNMPagamentos write SetNMPagamentos;

  end;

implementation

  uses UDM, System.SysUtils;

constructor TPagamentos.create;
begin
  CDPagamento := 0;
  NMPagamento := '' ;
end;

procedure TPagamentos.SetCDPagamentos(const Value: Integer);
begin
  XCDPagamentos := Value;
end;

procedure TPagamentos.SetNMPagamentos(const Value: String);
begin
  XNMPagamentos := Value;
end;

function TPagamentos.Inserir(var PCodigo : Integer; var PMensagem:String): Boolean;

begin

  try

    dm.DBFinanceiro.StartTransaction;
    XCDPagamentos := DM.GeraSequencial('GEN TIPOS_PAGAMENTOS') ;
    PCodigo := XCDPagamentos;

    dm.QInsere.Close;
    dm.QInsere.SQL.Clear;
    dm.QInsere.SQL.Add(' INSERT INTO TIPOS_PAGAMENTOS (CD_TIPO_PAGAMENTO, NM_TIPO_PAGAMENTO)'+
                       ' VALUES (:PCD_TIPO_PAGAMENTO, :PNM_TIPO_PAGAMENTO)');
    dm.QInsere.ParamByName('PCD_TIPO_Pagamento').AsInteger := XCDPagamentos ;
    dm.QInsere.ParamByName('PNM_TIPO_Pagamento').AsString  := XNMPagamentos;
    dm.QInsere.ExecSQL;

    dm.DBFinanceiro.Commit;
    dm.DBFinanceiro.CommitRetaining;

    Result := true;

  except
    on E: Exception do
    begin
      dm.DBFinanceiro.Rollback;
      PMensagem := e.Message;
      Result := false;
    end;
  end;

end;

function TPagamentos.Alterar(var PMensagem:String): Boolean;
begin
  try

    dm.DBFinanceiro.StartTransaction;
    dm.QUpdate.Close;
    dm.QUpdate.SQL.Clear;
    dm.QUpdate.SQL.Add(' UPDATE TIPOS_PAGAMENTOS SET NM_TIPO_PAGAMENTO=:PNM_TIPO_PAGAMENTO WHERE CD_TIPO_PAGAMENTO=:PCD_TIPO_PAGAMENTO');
    dm.QUpdate.ParamByName('PNM_TIPO_PAGAMENTO').AsString  := XNMPagamentos;
    dm.QUpdate.ParamByName('PCD_TIPO_PAGAMENTO').AsInteger := XCDPagamentos ;
    dm.QUpdate.ExecSQL;

    dm.DBFinanceiro.Commit;
    dm.DBFinanceiro.CommitRetaining;

    Result := true;

  except
    on E: Exception do
    begin
      dm.DBFinanceiro.Rollback;
      PMensagem := e.Message;
      Result := false;
    end;
  end;

end;

function TPagamentos.Apagar(var PMensagem:String): Boolean;
begin
  try

    dm.DBFinanceiro.StartTransaction;
    dm.QUpdate.Close;
    dm.QUpdate.SQL.Clear;
    dm.QUpdate.SQL.Add(' DELETE FROM TIPOS_PAGAMENTOS  WHERE CD_TIPO_PAGAMENTO=:PCD_TIPO_PAGAMENTO');
    dm.QUpdate.ParamByName('PCD_TIPO_PAGAMENTO').AsInteger := XCDPagamentos ;
    dm.QUpdate.ExecSQL;

    dm.DBFinanceiro.Commit;
    dm.DBFinanceiro.CommitRetaining;

    Result := true;

  except
    on E: Exception do
    begin
      dm.DBFinanceiro.Rollback;
      PMensagem := e.Message;
      Result := false;
    end;
  end;

end;

function TPagamentos.Localizar(PCodigo, PNome : String; var Query : TFDQuery): boolean;
begin
  Query.Close;
  Query.SQL.Clear;
  Query.SQL.Add(' select * from TIPOS_PAGAMENTOS WHERE 1=1');

  if trim(PCodigo)<>'' then
  begin
    Query.SQL.Add(' AND CD_TIPO_PAGAMENTO=:PCD_TIPO_PAGAMENTO') ;
    Query.ParamByName('PCD_TIPO_PAGAMENTO').AsString := PCodigo ;
  end;

  if trim(PNome)<>'' then
  begin
    Query.SQL.Add(' AND NM_TIPO_PAGAMENTO LIKE :PNOME');
    Query.ParamByName('PNOME').AsString := '%'+PNome+'%';
  end;

  Query.Open();

  if Query.IsEmpty then
  begin
    Result := false;
  end
  else
  begin
    Result := true;
  end;



end;





end.
